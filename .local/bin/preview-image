#!/usr/bin/sh
ID="lf-preview"
[ -p "$FIFO_UEBERZUG" ] || exit 1

[ $# = 1 ] && cmd=clear
case "${cmd:-$1}" in
    "draw")
        if echo "$(file -Lb --mime-type -- "$2")" | grep -Eq video/*; then
            FILENAME=/tmp/lf-preview.png
            ffmpegthumbnailer -i "$2" -o "$FILENAME" -s 0
        else
            FILENAME=$2
        fi
        {   printf '{ "action": "add", "identifier": "%s", "path": "%s",' "$ID" "$FILENAME"
            printf '"width": %d, "height": %d, "x": %d, "y": %d }\n' "$3" "$4" "$5" "$6"
        } > "$FIFO_UEBERZUG" ;;
    "clear")
        printf '{ "action": "remove", "identifier": "%s" }\n' "$ID" > "$FIFO_UEBERZUG" ;;
    "*") echo "Unknown command: '$1', '$2'" ;;
esac
